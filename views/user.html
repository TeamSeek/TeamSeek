<style>
#bioEl {
  margin-bottom: 20px;
}
.bio-edit {
  padding: 10px;
  border: solid;
  border-width: 1px;
}
textarea, .editarea div {
  display: inline-block;
  width: 100%;
  background-color: inherit;
  font-family:  inherit;
  vertical-align: top;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  padding: 0 20px;
}

textarea {
  border: none;
  resize: none;
  outline: none;
  font-size: inherit;
  height: 300px;
  padding: 0px;
  color: black;
}
textarea:disabled {
  /* bio displayed in a text area even when not active */
  color: black;
}

.skillbox {
  margin-top: 15px;
}
.skill {
  border-width: 1px;
  margin-right: 4px;
  margin-left: 4px;
  padding: 5px;
  border-radius: 12px;
  background-color: rgba(29, 144, 255, 0.42);
  cursor: pointer;
}
.newskill {
  font-size: 27px;
  color: #9C9C9C;
}
.avatar {
  margin-right: 15px;
	float: left;
  cursor: pointer;
  width: 80px;
  height: 80px;
}
.avatar:hover {
  background-color: white;
  opacity: 0.8;
}
.name-display {
  font-size: 25px;
  line-height: 35px;
}
.edit-link {
  margin-left: 30px;
  color: #1D90FF;
  cursor: pointer;
  line-height: 0;
}
.bio-display {
  white-space: pre-wrap;
  font-size: 16px;
  font-family:  "Lato", "Helvetica Neue", Helvetica, Arial, sans-serif;
}
#edit-input {
  background-color: white;
  color: black;
}
#Beginner {
  background-color: yellow;
}
#Intermediate {
  background-color: green; 
}
#Expert {
  background-color: #A10ACB;
  color: white;
}
</style>
<div class="centerbox">
  <div class="flexcenter">
    <!-- Left panel -->
    <div class="bigitem">
      <div id="projectdisplay">
        <div class="displayitem">
          <div style="margin: 20px 0 20px 0;">
            <div class="avatar" v-on:click="editAvatar()">
                <img id="avatar" class="avatar" src="{{user_details.avatar}}" />
            </div>
						<span class="name-display" v-else>{{user_details.full_name}}</span>
            <span class="name-display">({{user}})</span>
						<a class="edit-link" v-on:click="editName()" v-if="isOwnProfile && !editableName">Edit</a>
            <br />
            <b>Email: </b>
            <input id="edit-input" v-model="user_details.email" v-if="editableEmail" v-on:blur="saveEmail()" value="{{user_details.email}}"/>
            <span class="email-display" v-else>{{user_details.email}}</span>
            <span class="edit-link" v-on:click="editEmail()" v-if="isOwnProfile && !editableEmail">Edit</span>
            <br />
            <b>Join date: </b>
            <span class="joindate">{{user_details.join_date}}</span>
          </div>
		      <p class="edit-link" style="text-align: right;" v-on:click="editBio()" v-if="isOwnProfile && !editableBio">Edit</p>
          <div id="bioEl" v-cloak>
						<textarea v-if="editableBio" :spellcheck="editableBio" class="bio-edit"
                      v-model="user_details.bio" :disabled="!editableBio">{{user_details.bio}}</textarea>
            <pre class="bio-display" v-else>{{user_details.bio}}</pre>
            <button v-if="editableBio" class="accept-button" v-on:click="saveBio()">Save</button>
            <button v-if="editableBio" class="cancel-button" v-on:click="cancelBio()">Cancel</button>
            <div class="skillbox">
              <b>My Skills: </b>
              <span v-for="skill in user_details.user_skills" v-on:click="changeLevel($index)" class="skill" id="{{user_details.skill_levels[$index]}}" >{{skill}}</span>
              <i class="icon-plus-sign newskill" v-on:click="addSkill()" v-if="isOwnProfile"></i>
            </div>
          </div>
        </div>
        <div class="displayitem">
          <h2>Projects from {{user}}</h2>
          <div v-if="showSpinner" class="spinnerBox" id="spinnerBox"></div>
          <div class="projectbox" v-for="project in projects" v-cloak>
            <img align=left v-bind:src="project.imageUrl">
            </img>
            <h1><a href="/{{project.owner}}/{{project.title}}">{{project.title}}</a></h1>
            <p>{{project.short_desc}}</p>
          </div>
          <p v-if="projects.length == 0 && ! showSpinner">No projects found<p>
          <div style="height:0px;">
            <span class="footer">
              <a href="#">About</a>
              <a href="#">Contact</a>
              <a href="#">Terms of service</a>
            </span>
          </div>
        </div>
      </div>
    </div>
    <!-- Right panel -->
    <div class="smallitem">
      <div class="displayitem">
        <h2>Notifications</h2>
        <p><i>No new notifications</i></p>
      </div>
    </div>
  </div>
</div>
<script>
var gravatar = 'http://www.gravatar.com/avatar/MD5_HASH?d=identicon';
Vue.http.options.emulateJSON = true;
function addGravatars(projectArray) {
    for (index in projectArray) {
      if (!projectArray[index].imageUrl) {
        var hashSrc = projectArray[index].owner + '/' + projectArray[index].title;
        var md5 = CryptoJS.MD5(hashSrc).toString();
        projectArray[index].imageUrl = gravatar.replace('MD5_HASH',md5);
      }
    }
}

var projectdisplay = new Vue({
  el: '#projectdisplay',
  ready: function() {
    this.$http.get('/api/projects', {action: 'my_projects', owner:_onload_data.user}).then(function (response) {
      this.projects = response.data;
      addGravatars(this.projects);
      this.showSpinner = false;
    });
    var user_details = {action:'user_details', username:_onload_data.user};
    this.$http.get('/api/users', user_details).then(function (response) {
      console.log(response.data);
			this.user_details = response.data || {};
      if (response.data.bio) this.user_details.bio = response.data.bio;
      else this.user_details.bio = 'User "' + _onload_data.user + '" has not yet made a bio!';
    }, function (response) {
      // error callback
      this.showSpinner = false;
    });
  },
  methods: {
    editBio: function() {
      this.oldBio = this.user_details.bio;
      this.editableBio = true;
    },
    saveBio: function() {
      this.editableBio = false;
      var edit_bio = {action:'edit_bio', data:this.user_details.bio};
      this.$http.post('/api/users/', edit_bio).then(function (response) {

      }, function(response) {
        alert('There was an issue saving the bio');
      });
    },
    cancelBio: function() {
      this.user_details.bio = this.oldBio;
      this.editableBio = false;
    },
    /* enable input box for name */
    editName: function() {
      this.editableName = true;
    },
    /* saving name into database */
    saveName: function() {
      edit_full_name = {action: 'edit_full_name', data: this.user_details.full_name};
      this.$http.post('/api/users/', edit_full_name).then(function (response) {
       /* if saving is successful, do some commands here if necesssary */ 
      }, 
      /* if saving name failed */ 
      function(response) {
        alert("There's something wrong while saving name");
      });
      this.editableName = false;
    },
    /* enable input box for email */
    editEmail: function() {
      this.editableEmail = true;
    },
    /* saving email into database */
    saveEmail: function() {
      edit_email = {action: 'edit_email', data: this.user_details.email};
      this.$http.post('/api/users/', edit_email).then(function (response) {
        /* saving is successful, do something in here if necessary */
      },
      /* if saving failed somehow */
      function(response) {
        alert("There's something wrong while saving email");
      });
      this.editableEmail = false;
    },
    /* Changing skill level */
    changeLevel: function(index) {
      /* Edit skill_level at index location */
      level = this.user_details.skill_levels[index];
      level_map = {"Beginner": "Intermediate", "Intermediate": "Expert", "Expert": "Beginner"};
      this.user_details.skill_levels[index] = level_map[level];
      /* Update in database */
      edit_skill_level = {"action": "edit_skill_level", "skill": this.user_details.user_skills[index], "data": level_map[level]};
      this.$http.post('/api/users/', edit_skill_level).then(function (response) {
        /* successful*/ 
        document.getElementById(level).id = level_map[level];
      },
      function (response) {
        alert(response);
      });
    },
    addSkill: function() {
      skill = prompt('Enter skill name');
      console.log(skill);
      var addSkill = {action:'add_skill', skill:skill};
      this.$http.put('/api/users/', addSkill).then(function (response) {
      },
      function(response) {
        alert(response);
      });
    },
    /* Changing avatar */
    editAvatar: function() {
      var URL = prompt("Please enter new avatar's URL: ");
      /* Update avatar in database */
      edit_avatar = {"action": "edit_avatar", "data": URL};
      this.$http.post('/api/users/', edit_avatar).then(function (response) {
        /* Successful */
        document.getElementById('avatar').src = URL;
      },
      function(response) {
        alert("There's something wrong while changing avatar");
      });
    }
  },
  data: {
    projects: [],
    myIdeas: [],
    editableName: false,
    editableEmail: false,
    editableBio: false,
		user_details: {},
    oldBio: null, /* save old bio in case the users discards changes */
    user: _onload_data.user,
    isOwnProfile: _onload_data.isOwnProfile,
    showSpinner: true
  }
});
</script>
